# 二次修复说明

## 新发现的问题

根据最新测试反馈：

### 学生管理
1. ✅ **列表显示问题** - 姓名一栏显示为空（实际显示的是学号）
2. ✅ **新增功能问题** - 新增学生后不显示在列表中
3. ✅ **查询功能问题** - 无法正常查询

### 资产管理
1. ✅ **新增功能问题** - 新增资产后不显示在列表中
2. ✅ **查询功能问题** - 无法查询到任何东西

## 问题根本原因

### 学生表结构问题
```
student 表字段：
- id, user_id, student_number, class_id, enrollment_date, ...
- ❌ 没有 name 字段

user 表字段：
- id, username, real_name, ...
- ✅ real_name 字段存储姓名
```

**问题**：前端期望显示"姓名"列，但 student 表没有 name 字段，需要关联 user 表获取 `real_name`

### 新增逻辑问题
- 学生新增时只创建了 student 记录，没有创建对应的 user 记录
- 资产新增可能因为字段缺失或类型转换失败

## 修复方案

### 1. 学生列表接口 (`BackendController.java`)

**修改前**：
```java
@GetMapping("/student/list")
public ApiResult<PageResult<Student>> listStudents(...) {
    Page<Student> result = studentMapper.selectPage(page, wrapper);
    return ApiResult.success(PageResult.of(result));
}
```

**修改后**：
```java
@GetMapping("/student/list")
public ApiResult<PageResult<Map<String, Object>>> listStudents(
        @RequestParam(required = false) Long schoolId,
        @RequestParam(required = false) Long classId,
        @RequestParam(required = false) String keyword,  // 新增关键词查询
        ...) {

    // 支持按姓名/学号模糊查询
    if (keyword != null && !keyword.trim().isEmpty()) {
        // 查询用户表获取姓名匹配的用户ID
        LambdaQueryWrapper<User> userWrapper = new LambdaQueryWrapper<>();
        userWrapper.like(User::getRealName, keyword).or().like(User::getUsername, keyword);
        List<User> users = userMapper.selectList(userWrapper);
        List<Long> userIds = users.stream().map(User::getId).collect(Collectors.toList());

        if (!userIds.isEmpty()) {
            wrapper.in(Student::getUserId, userIds);
        } else {
            wrapper.like(Student::getStudentNumber, keyword);
        }
    }

    Page<Student> result = studentMapper.selectPage(page, wrapper);

    // 关联查询用户信息，返回包含姓名的数据
    List<Map<String, Object>> records = new ArrayList<>();
    for (Student student : result.getRecords()) {
        Map<String, Object> map = new HashMap<>();
        map.put("id", student.getId());
        map.put("studentNumber", student.getStudentNumber());
        map.put("classId", student.getClassId());
        map.put("guardianName", student.getGuardianName());
        map.put("guardianPhone", student.getGuardianPhone());
        map.put("enrollmentDate", student.getEnrollmentDate());
        map.put("status", student.getStatus());

        // 关联查询用户姓名
        User user = userMapper.selectById(student.getUserId());
        map.put("name", user != null ? user.getRealName() : "");

        // 关联查询班级名称
        com.education.platform.entity.Class classInfo = classMapper.selectById(student.getClassId());
        map.put("className", classInfo != null ? classInfo.getClassName() : "");

        records.add(map);
    }

    Page<Map<String, Object>> finalPage = new Page<>(current, size);
    finalPage.setRecords(records);
    finalPage.setTotal(result.getTotal());

    return ApiResult.success(PageResult.of(finalPage));
}
```

### 2. 学生新增接口 (`BackendController.java`)

**修改前**：
```java
@PostMapping("/student/add")
public ApiResult<Boolean> addStudent(@RequestBody Student student) {
    student.setStatus(1);
    if (student.getEnrollmentDate() == null) {
        student.setEnrollmentDate(LocalDate.now());
    }
    int result = studentMapper.insert(student);
    return ApiResult.success(result > 0);
}
```

**修改后**：
```java
@PostMapping("/student/add")
public ApiResult<Boolean> addStudent(@RequestBody Map<String, Object> studentData) {
    // 1. 创建 User 记录
    User user = new User();
    user.setUsername("student_" + studentData.get("studentNumber"));
    user.setPassword("$2a$10$..."); // 默认密码
    user.setRealName((String) studentData.get("name"));  // 姓名
    user.setPhone((String) studentData.get("guardianPhone"));
    user.setEmail(studentData.get("studentNumber") + "@edu.com");
    user.setStatus(1);
    userMapper.insert(user);

    // 2. 创建 Student 记录
    Student student = new Student();
    student.setUserId(user.getId());  // 关联刚创建的用户
    student.setStudentNumber((String) studentData.get("studentNumber"));
    student.setClassId(Long.parseLong(studentData.get("classId").toString()));
    student.setGuardianName((String) studentData.get("guardianName"));
    student.setGuardianPhone((String) studentData.get("guardianPhone"));
    student.setStatus(1);
    student.setEnrollmentDate(LocalDate.now());

    studentMapper.insert(student);
    return ApiResult.success(true);
}
```

### 3. 资产列表接口 (`BackendController.java`)

**新增功能**：
- 添加关键词查询（资产名称/编码）
- 添加排序（按创建时间倒序）

```java
@GetMapping("/asset/list")
public ApiResult<PageResult<OfficeAsset>> listAssets(
        @RequestParam(required = false) Long schoolId,
        @RequestParam(required = false) String category,
        @RequestParam(required = false) String keyword,  // 新增
        ...) {

    LambdaQueryWrapper<OfficeAsset> wrapper = new LambdaQueryWrapper<>();

    if (schoolId != null) {
        wrapper.eq(OfficeAsset::getSchoolId, schoolId);
    }
    if (category != null) {
        wrapper.eq(OfficeAsset::getCategory, category);
    }
    if (keyword != null && !keyword.trim().isEmpty()) {
        wrapper.like(OfficeAsset::getAssetName, keyword)
               .or().like(OfficeAsset::getAssetCode, keyword);
    }

    wrapper.orderByDesc(OfficeAsset::getCreatedAt);

    Page<OfficeAsset> result = officeAssetMapper.selectPage(page, wrapper);
    return ApiResult.success(PageResult.of(result));
}
```

### 4. 资产新增接口 (`BackendController.java`)

**修改前**：
```java
@PostMapping("/asset/add")
public ApiResult<Boolean> addAsset(@RequestBody OfficeAsset asset) {
    asset.setStatus(1);
    if (asset.getAssetCode() == null) {
        asset.setAssetCode("ASSET" + System.currentTimeMillis());
    }
    if (asset.getTotalValue() == null && asset.getQuantity() != null && asset.getUnitPrice() != null) {
        asset.setTotalValue(asset.getUnitPrice().multiply(BigDecimal.valueOf(asset.getQuantity())));
    }
    int result = officeAssetMapper.insert(asset);
    return ApiResult.success(result > 0);
}
```

**修改后**：
```java
@PostMapping("/asset/add")
public ApiResult<Boolean> addAsset(@RequestBody Map<String, Object> assetData) {
    OfficeAsset asset = new OfficeAsset();

    // 处理各种字段类型转换和默认值
    Object schoolIdObj = assetData.get("schoolId");
    if (schoolIdObj != null) {
        asset.setSchoolId(Long.parseLong(schoolIdObj.toString()));
    }

    String assetName = (String) assetData.get("assetName");
    if (assetName == null || assetName.trim().isEmpty()) {
        return ApiResult.error("资产名称不能为空");
    }
    asset.setAssetName(assetName);

    // 资产编码（自动生成）
    String assetCode = (String) assetData.get("assetCode");
    if (assetCode == null || assetCode.trim().isEmpty()) {
        assetCode = "ASSET" + System.currentTimeMillis();
    }
    asset.setAssetCode(assetCode);

    // 分类（默认值）
    String category = (String) assetData.get("category");
    if (category == null || category.trim().isEmpty()) {
        category = "equipment";
    }
    asset.setCategory(category);

    // 数量（默认1）
    Object quantityObj = assetData.get("quantity");
    asset.setQuantity(quantityObj != null ? Integer.parseInt(quantityObj.toString()) : 1);

    // 单价（类型转换）
    Object unitPriceObj = assetData.get("unitPrice");
    if (unitPriceObj != null) {
        asset.setUnitPrice(new BigDecimal(unitPriceObj.toString()));
    }

    // 计算总价值
    if (asset.getUnitPrice() != null && asset.getQuantity() != null) {
        asset.setTotalValue(asset.getUnitPrice().multiply(BigDecimal.valueOf(asset.getQuantity())));
    }

    // 其他字段
    asset.setLocation((String) assetData.get("location"));
    asset.setResponsiblePerson((String) assetData.get("responsiblePerson"));
    asset.setSpecification((String) assetData.get("specification"));

    // 采购日期处理
    Object purchaseDateObj = assetData.get("purchaseDate");
    if (purchaseDateObj != null && purchaseDateObj instanceof String) {
        asset.setPurchaseDate(java.time.LocalDate.parse((String) purchaseDateObj));
    }

    asset.setStatus(1); // 正常状态

    int result = officeAssetMapper.insert(asset);
    return ApiResult.success(result > 0);
}
```

## 测试数据验证

### 当前数据库状态

```bash
# 学生表（3条记录，都有对应的user）
mysql> SELECT s.id, s.student_number, u.real_name, s.class_id
       FROM student s LEFT JOIN user u ON s.user_id = u.id;
+----+----------------+-----------+----------+
| id | student_number | real_name | class_id |
+----+----------------+-----------+----------+
|  1 | 20221120139    | 崔宇杭    |        1 |
|  2 | 20221120140    | 李明      |        1 |
|  3 | 20221120141    | 王芳      |        2 |
+----+----------------+-----------+----------+

# 资产表（3条记录）
mysql> SELECT id, asset_code, asset_name, school_id FROM office_asset;
+----+------------+--------------+----------+
| id | asset_code | asset_name   | school_id|
+----+------------+--------------+----------+
|  1 | EQ001      | 台式计算机   |        1 |
|  2 | FU001      | 办公桌       |        1 |
|  3 | EL001      | 投影仪       |        2 |
+----+------------+--------------+----------+
```

## 使用说明

### 1. 重启应用
代码已修改，必须重启 Spring Boot 应用才能生效。

### 2. 学生管理测试

**查询学生（带姓名）**
```
GET http://localhost:3000/backend/student/list
```
返回示例：
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 1,
        "studentNumber": "20221120139",
        "name": "崔宇杭",  // ✅ 现在会显示姓名
        "className": "一年级1班",
        "guardianName": "崔父",
        "guardianPhone": "13800138001",
        "enrollmentDate": "2022-09-01",
        "status": 1
      }
    ]
  }
}
```

**按姓名查询**
```
GET http://localhost:3000/backend/student/list?keyword=崔
```

**新增学生**
```
POST http://localhost:3000/backend/student/add
Content-Type: application/json

{
    "name": "张三",
    "studentNumber": "20221120142",
    "classId": 1,
    "guardianName": "张父",
    "guardianPhone": "13800138099"
}
```

### 3. 资产管理测试

**查询资产**
```
GET http://localhost:3000/backend/asset/list
GET http://localhost:3000/backend/asset/list?keyword=计算机
```

**新增资产**
```
POST http://localhost:3000/backend/asset/add
Content-Type: application/json

{
    "schoolId": 1,
    "assetName": "笔记本电脑",
    "category": "electronic",
    "quantity": 5,
    "unitPrice": 6000.00,
    "location": "办公室",
    "responsiblePerson": "测试人员"
}
```

## 关键修复点总结

| 问题 | 原因 | 修复 |
|------|------|------|
| 学生姓名显示为空 | student表无name字段，需关联user表 | 列表接口关联查询user表返回real_name |
| 学生新增后不显示 | 只创建student记录，缺少user记录 | 新增接口同时创建user和student记录 |
| 学生查询失败 | 缺少关键词查询功能 | 添加keyword参数，支持姓名/学号模糊查询 |
| 资产新增后不显示 | 字段类型转换失败或缺失必填字段 | 使用Map接收参数，添加类型转换和默认值 |
| 资产查询失败 | 缺少关键词查询功能 | 添加keyword参数，支持名称/编码模糊查询 |

## 注意事项

1. **重启应用**：所有修改都需要重启应用才能生效
2. **数据库约束**：student表的user_id是唯一约束，新增时需确保user记录先创建
3. **字段类型**：前端传入的数字可能是字符串，需要类型转换
4. **必填字段**：新增时需要验证必填字段，给出明确错误提示
