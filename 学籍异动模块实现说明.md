# 学籍异动模块实现说明

## 概述
本模块实现了完整的学籍异动管理功能，包括学生提交申请、管理员审核、数据统计等功能。遵循角色权限分离原则，为不同角色分配差异化权限。

## 功能特性

### 1. 学生端功能
- **查看个人学籍异动记录**：学生可以查看自己提交的所有学籍异动申请
- **提交学籍异动申请**：支持以下异动类型：
  - 休学（需要填写结束日期）
  - 转学（需要填写目标学校）
  - 复学
  - 退学（需要填写结束日期）
  - 其他
- **实时状态跟踪**：查看申请审核状态（待审核/已通过/已驳回）
- **审核意见查看**：查看管理员的审核意见

### 2. 管理员端功能
- **学籍异动管理**：查看所有学生的学籍异动申请
- **多维度搜索**：按学生姓名、异动类型、审核状态筛选
- **审核功能**：
  - 通过申请：可填写审核意见
  - 驳回申请：必须填写驳回原因
- **删除功能**：删除已审核完成的申请记录
- **统计看板**：
  - 总申请数
  - 待审核数
  - 已通过数
  - 已驳回数

## 技术实现

### 后端实现

#### 1. 数据库表结构
```sql
CREATE TABLE `student_status_change` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `student_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL,
  `change_type` TINYINT NOT NULL,
  `reason` TEXT NOT NULL,
  `start_date` DATE NOT NULL,
  `end_date` DATE,
  `target_school` VARCHAR(100),
  `status` TINYINT DEFAULT 0,
  `approval_comment` VARCHAR(500),
  `approver_id` BIGINT,
  `approval_time` DATETIME,
  `deleted` TINYINT DEFAULT 0,
  `created_at` DATETIME,
  `updated_at` DATETIME,
  PRIMARY KEY (`id`)
);
```

#### 2. 实体类
- **文件**: `E:\shixun\backend\src\main\java\com\education\platform\entity\StudentStatusChange.java`
- **说明**: 继承BaseEntity，包含所有字段的getter/setter

#### 3. Mapper接口
- **文件**: `E:\shixun\backend\src\main\java\com\education\platform\mapper\StudentStatusChangeMapper.java`
- **说明**: 继承BaseMapper，提供基础CRUD操作

#### 4. API接口（BackendController.java）
| 接口路径 | 方法 | 权限 | 说明 |
|---------|------|------|------|
| `/backend/status-change/apply` | POST | 所有登录用户 | 提交学籍异动申请 |
| `/backend/status-change/list` | GET | ADMIN | 获取所有申请列表（支持分页、搜索） |
| `/backend/status-change/my-list` | GET | 所有登录用户 | 获取我的申请列表 |
| `/backend/status-change/approve` | POST | ADMIN | 审核申请（通过/驳回） |
| `/backend/status-change/delete` | DELETE | ADMIN | 删除申请 |
| `/backend/status-change/statistics` | GET | ADMIN | 获取统计数据 |

### 前端实现

#### 1. API文件
- **学生API**: `E:\shixun\frontend\src\api\campus.js`
  - `applyStatusChange(data)` - 提交申请
  - `getMyStatusChanges(params)` - 获取我的申请列表

- **管理员API**: `E:\shixun\frontend\src\api\admin.js`
  - `getStatusChanges(params)` - 获取所有申请
  - `approveStatusChange(params)` - 审核申请
  - `deleteStatusChange(id)` - 删除申请
  - `getStatusChangeStatistics()` - 获取统计信息

#### 2. 页面组件

**学生端页面** (`E:\shixun\frontend\src\views\campus\StatusChange.vue`)
- 顶部操作卡片：新建申请按钮
- 我的申请列表表格
- 申请对话框：动态表单验证
  - 根据异动类型显示不同字段
  - 实时验证规则调整

**管理员端页面** (`E:\shixun\frontend\src\views\admin\StudentStatusManagement.vue`)
- 统计卡片：4个状态统计
- 搜索筛选区：姓名、类型、状态
- 数据表格：完整信息展示
- 审核对话框：查看详情并填写意见

#### 3. 路由配置
```javascript
// 学生端路由
{
  path: 'status-change',
  name: 'StatusChange',
  component: () => import('@/views/campus/StatusChange.vue'),
  meta: { title: '学籍异动' }
}

// 管理端路由
{
  path: 'status-change',
  name: 'StudentStatusManagement',
  component: () => import('@/views/admin/StudentStatusManagement.vue'),
  meta: { title: '学籍异动管理' }
}
```

#### 4. 菜单配置
- **学生布局** (`E:\shixun\frontend\src\views\Layout.vue`): 添加"学籍异动"菜单项
- **管理布局** (`E:\shixun\frontend\src\views\admin\Layout.vue`): 添加"学籍异动管理"菜单项

### 5. 权限控制

#### 前端路由守卫
- 已配置在 `E:\shixun\frontend\src\router\index.js`
- 根据用户角色自动跳转到对应页面
- 无权限用户会显示警告并跳转

#### 后端接口权限
- 使用 Spring Security `@PreAuthorize` 注解
- 学生端接口：`@PreAuthorize("isAuthenticated()")`
- 管理端接口：`@PreAuthorize("hasRole('ADMIN')")`

## 权限分配详情

| 角色 | 菜单访问 | 操作权限 | 说明 |
|------|---------|---------|------|
| **学生 (STUDENT)** | 学籍异动 | 提交申请、查看个人记录 | 只能操作自己的数据 |
| **管理员 (ADMIN)** | 学籍异动管理 | 查看所有、审核、删除、统计 | 完整管理权限 |
| **教师 (TEACHER)** | - | 查看统计（可选） | 可查看班级统计信息 |
| **家长 (PARENT)** | 学籍异动 | 查看关联学生的记录 | 只读权限 |
| **普通用户 (USER)** | 学籍异动 | 提交申请、查看个人记录 | 同学生权限 |

## 数据流转

### 1. 学生提交申请流程
```
学生填写表单 → 前端验证 → 调用 /apply 接口 →
后端验证权限 → 保存到数据库 → 返回成功 →
前端显示成功提示 → 自动刷新申请列表
```

### 2. 管理员审核流程
```
管理员查看列表 → 点击审核 → 打开对话框 →
填写审核意见 → 选择通过/驳回 → 调用 /approve 接口 →
更新状态和审核信息 → 刷新列表和统计数据
```

## 异动类型说明

| 类型值 | 类型名称 | 必填字段 | 说明 |
|--------|---------|---------|------|
| 1 | 休学 | 结束日期 | 需要填写休学结束时间 |
| 2 | 转学 | 目标学校 | 需要填写目标学校名称 |
| 3 | 复学 | - | 正常复学 |
| 4 | 退学 | 结束日期 | 需要填写退学时间 |
| 5 | 其他 | - | 其他特殊情况 |

## 状态说明

| 状态值 | 状态名称 | 说明 |
|--------|---------|------|
| 0 | 待审核 | 新提交的申请 |
| 1 | 已通过 | 管理员审核通过 |
| 2 | 已驳回 | 管理员审核驳回 |

## 文件清单

### 后端文件
1. `E:\shixun\backend\src\main\java\com\education\platform\entity\StudentStatusChange.java`
2. `E:\shixun\backend\src\main\java\com\education\platform\mapper\StudentStatusChangeMapper.java`
3. `E:\shixun\backend\src\main\java\com\education\platform\controller\BackendController.java` (已修改)

### 前端文件
1. `E:\shixun\frontend\src\api\campus.js` (已修改)
2. `E:\shixun\frontend\src\api\admin.js` (已修改)
3. `E:\shixun\frontend\src\views\campus\StatusChange.vue` (新建)
4. `E:\shixun\frontend\src\views\admin\StudentStatusManagement.vue` (新建)
5. `E:\shixun\frontend\src\views\Layout.vue` (已修改)
6. `E:\shixun\frontend\src\views\admin\Layout.vue` (已修改)
7. `E:\shixun\frontend\src\router\index.js` (已修改)

### 数据库脚本
1. `E:\shixun\backend\database\add_student_status_change_table.sql`
2. `E:\shixun\backend\database\add_status_change_permissions.sql`

## 部署步骤

### 1. 数据库初始化
```bash
# 执行建表脚本
mysql -u root -p education_platform < E:\shixun\backend\database\add_student_status_change_table.sql

# 执行权限配置脚本（可选，如果使用权限系统）
mysql -u root -p education_platform < E:\shixun\backend\database\add_status_change_permissions.sql
```

### 2. 后端部署
- 重新编译并启动 Spring Boot 应用
- 系统会自动扫描新的 Mapper 和 Controller

### 3. 前端部署
```bash
cd E:\shixun\frontend
npm install
npm run build
```

### 4. 测试验证
1. 使用学生账号登录，测试申请功能
2. 使用管理员账号登录，测试审核功能
3. 验证权限控制是否正确

## 注意事项

1. **数据库表必须先创建**：在使用功能前，请先执行建表脚本
2. **权限配置**：如果系统使用了权限管理，需要执行权限配置脚本
3. **前端路由**：确保路由配置正确，否则页面无法访问
4. **API路径**：检查后端API路径是否与前端调用一致
5. **跨域问题**：确保后端已配置正确的CORS策略

## 常见问题

### Q: 学生无法提交申请
**A**: 检查：
1. 用户是否已登录
2. 用户是否有STUDENT或USER角色
3. 数据库表是否已创建

### Q: 管理员无法审核
**A**: 检查：
1. 用户是否有ADMIN角色
2. 后端接口权限注解是否正确

### Q: 页面显示404
**A**: 检查：
1. 路由是否已配置
2. 菜单项是否已添加
3. 文件路径是否正确

## 更新日志

### v1.0 (2026-01-07)
- ✅ 完成学籍异动模块基础功能
- ✅ 实现学生端申请和查看功能
- ✅ 实现管理员端审核和管理功能
- ✅ 添加统计看板
- ✅ 配置角色权限
- ✅ 完成前后端联调

---

**开发团队**: Education Platform Team
**最后更新**: 2026-01-07
