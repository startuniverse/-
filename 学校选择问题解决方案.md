# 教师注册学校选择问题解决方案

## 问题描述
在教师注册页面，学校下拉框显示"No data"，无法选择学校，导致无法完成注册。

## 解决方案
提供**两种方式**解决此问题：

### 方案一：添加学校数据到数据库（推荐）
执行SQL脚本添加预设学校数据

### 方案二：支持手动输入学校名称
修改前端页面，支持在没有学校数据时手动输入学校名称

---

## 方案一：添加学校数据

### 执行脚本
```bash
# 连接到MySQL数据库
mysql -u root -p

# 执行添加学校脚本
source E:/shixun/backend/database/INSERT_SCHOOLS.sql;
```

### 脚本内容
该脚本会添加以下学校：
- **云南大学** (根据用户要求)
- 第一中学、第二中学、第三中学
- 实验小学、育才小学
- 职业技术学校

### 验证数据
```sql
SELECT * FROM school WHERE deleted = 0;
```

---

## 方案二：支持手动输入学校

### 前端修改（已完成）

#### 1. 登录页面 - Login.vue
```
登录页面底部添加：
[普通用户注册] [教师注册]  <-- 新增链接
```

#### 2. 教师注册页面 - TeacherRegister.vue
**新增功能**：
- ✅ 学校下拉选择（如果数据库有数据）
- ✅ 手动输入学校名称（如果下拉为空）
- ✅ 切换输入方式的链接
- ✅ 智能提示

**页面布局**：
```
教师注册表单
├── 用户名、密码、确认密码
├── 真实姓名、手机号、邮箱
├── 部门、职称
├── 学校选择：
│   ├── 方式1：下拉选择（如果有数据）
│   └── 方式2：手动输入（如果无数据）
└── 注册按钮
```

**智能切换逻辑**：
- 加载学校列表失败 → 自动切换到手动输入
- 学校列表为空 → 显示"没有学校可选？点击手动输入"
- 已有学校 → 显示"手动输入新学校"链接

### 后端修改（已完成）

#### 1. AuthController.java
**新增功能**：
- 支持 `customSchoolName` 参数
- 自动创建新学校（如果手动输入）
- 自动分配学校ID

**处理流程**：
```
1. 接收注册请求
2. 检查是否有 schoolId（选择现有学校）
3. 如果没有，检查是否有 customSchoolName（手动输入）
4. 如果有 customSchoolName，创建新学校记录
5. 使用新学校的ID完成注册
```

#### 2. 新增接口
- `GET /backend/school/list` - 获取学校列表（公开）

---

## 使用流程

### 场景1：数据库中有学校数据
```
1. 访问 /teacher-register
2. 页面自动加载学校列表
3. 从下拉框选择学校（如：云南大学）
4. 填写其他信息
5. 点击注册
6. 成功
```

### 场景2：数据库中没有学校数据
```
1. 访问 /teacher-register
2. 页面检测到无学校数据
3. 自动切换到手动输入模式
4. 输入学校名称（如：云南大学）
5. 填写其他信息
6. 点击注册
7. 后端自动创建学校记录
8. 成功
```

### 场景3：想添加新学校
```
1. 访问 /teacher-register
2. 从下拉框选择（或点击"手动输入新学校"）
3. 输入新学校名称
4. 填写其他信息
5. 点击注册
6. 新学校自动创建
7. 成功
```

---

## 技术实现细节

### 前端关键代码

#### 动态验证规则
```javascript
const getDynamicRules = () => {
  if (useCustomSchool.value) {
    return { ...baseRules, customSchoolName: required }
  } else {
    return { ...baseRules, schoolId: required }
  }
}
```

#### 智能切换
```javascript
// 加载学校失败时自动切换
if (schools.value.length === 0) {
  useCustomSchool.value = true
}
```

#### 数据提交
```javascript
if (useCustomSchool.value) {
  data.customSchoolName = registerForm.customSchoolName
} else {
  data.schoolId = registerForm.schoolId
}
```

### 后端关键代码

#### 学校自动创建
```java
if (schoolId == null && customSchoolName != null) {
  School newSchool = new School();
  newSchool.setSchoolCode("S" + System.currentTimeMillis());
  newSchool.setSchoolName(customSchoolName);
  // 设置默认值...
  schoolMapper.insert(newSchool);
  schoolId = newSchool.getId();
}
```

---

## 测试步骤

### 1. 执行SQL脚本（可选）
```bash
mysql> source E:/shixun/backend/database/INSERT_SCHOOLS.sql;
```

### 2. 启动服务
```bash
# 后端
mvn spring-boot:run

# 前端
npm run dev
```

### 3. 测试注册
```
访问: http://localhost:5173/login
点击: "教师注册"
填写: 所有必填字段
学校: 选择或手动输入
提交: "注册教师账户"
结果: 成功提示 + 跳转登录
```

### 4. 验证数据
```sql
-- 查看新创建的教师
SELECT u.username, u.real_name, r.role_code
FROM user u
JOIN user_role ur ON u.id = ur.user_id
JOIN role r ON ur.role_id = r.id
WHERE u.username LIKE 'teacher%';

-- 查看新创建的学校（如果手动输入）
SELECT * FROM school ORDER BY id DESC LIMIT 5;
```

---

## 文件修改清单

### 前端文件
| 文件 | 修改内容 |
|------|----------|
| `Login.vue` | 添加"教师注册"链接 |
| `TeacherRegister.vue` | 新增，支持两种学校输入方式 |
| `auth.js` | 新增 `registerTeacher()` 方法 |
| `index.js` | 新增路由 `/teacher-register` |

### 后端文件
| 文件 | 修改内容 |
|------|----------|
| `AuthController.java` | 支持 customSchoolName，自动创建学校 |
| `UserServiceImpl.java` | 教师注册逻辑 |
| `UserMapper.java` | 角色分配方法 |
| `INSERT_SCHOOLS.sql` | 新增，添加学校数据 |

---

## 优势对比

### 仅添加学校数据
**优点**：
- 简单直接
- 数据规范统一

**缺点**：
- 需要预先知道所有学校
- 新增学校需要手动执行SQL

### 仅支持手动输入
**优点**：
- 灵活，随时可添加新学校
- 用户体验好

**缺点**：
- 学校名称可能不规范
- 可能产生重复数据

### 两者结合（当前方案）⭐
**优点**：
- ✅ 有数据时选择，无数据时输入
- ✅ 自动切换，无需配置
- ✅ 后端自动创建新学校
- ✅ 用户体验最佳

---

## 常见问题

### Q1: 为什么还是显示"No data"？
**A**: 请检查：
1. 数据库连接是否正常
2. 是否执行了学校添加脚本
3. 浏览器缓存（Ctrl+F5强制刷新）
4. 后端服务是否正常启动

### Q2: 手动输入的学校在哪里查看？
**A**: 在数据库的school表中，会自动创建：
```sql
SELECT * FROM school WHERE school_name = '你输入的学校名称';
```

### Q3: 如何防止重复创建学校？
**A**: 当前实现每次手动输入都会创建新学校。如需防止重复，可以：
1. 在前端搜索现有学校
2. 在后端检查学校名称是否已存在

### Q4: 学校类型如何确定？
**A**: 当前默认为 `secondary`（中学）。如需修改，可在后端代码中调整：
```java
newSchool.setSchoolType("primary"); // 小学
newSchool.setSchoolType("university"); // 大学
```

---

## 总结

通过本次修改，教师注册页面现在支持：

1. ✅ **自动检测**：检测数据库是否有学校数据
2. ✅ **智能切换**：无数据时自动切换到手动输入
3. ✅ **灵活选择**：用户可选择现有学校或输入新学校
4. ✅ **后端处理**：自动创建新学校记录
5. ✅ **完整验证**：前后端双重验证

**用户操作**：
- 有学校 → 直接选择
- 无学校 → 手动输入
- 新学校 → 手动输入自动创建

**最终效果**：无论数据库中是否有学校数据，教师都能顺利完成注册！
