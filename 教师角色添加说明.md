# 教师用户角色添加说明

## 项目概述
在现有的教育平台中添加教师用户角色（TEACHER），实现教师身份的注册、登录和管理功能。

## 当前系统角色
- **ADMIN** - 系统管理员
- **USER** - 普通用户
- **TEACHER** - 教师用户（新增）

## 修改内容

### 1. 数据库相关

#### 1.1 添加TEACHER角色
执行脚本：`backend/database/ADD_TEACHER_ROLE_COMPLETE.sql`

```sql
INSERT INTO role (role_code, role_name, description, deleted)
VALUES ('TEACHER', '教师', '教师用户角色，可以管理班级学生、录入成绩等', 0);
```

### 2. Mapper层修改

#### 2.1 UserMapper.java
添加两个新方法：
```java
// 为用户分配角色
void assignRoleToUser(@Param("userId") Long userId, @Param("roleId") Long roleId);

// 根据角色编码查询角色ID
Long selectRoleIdByCode(@Param("roleCode") String roleCode);
```

#### 2.2 UserMapper.xml
添加对应的SQL映射：
```xml
<!-- 为用户分配角色 -->
<insert id="assignRoleToUser">
    INSERT IGNORE INTO user_role (user_id, role_id) VALUES (#{userId}, #{roleId})
</insert>

<!-- 根据角色编码查询角色ID -->
<select id="selectRoleIdByCode" resultType="java.lang.Long">
    SELECT id FROM role WHERE role_code = #{roleCode} AND deleted = 0
</select>
```

### 3. Service层修改

#### 3.1 IUserService.java
添加新方法：
```java
// 用户注册并指定角色
Boolean registerWithRole(User user, String roleCode);

// 教师注册（自动分配TEACHER角色）
Boolean registerTeacher(User user);

// 为用户分配角色
Boolean assignRole(Long userId, String roleCode);
```

#### 3.2 UserServiceImpl.java
实现新方法：
- `registerWithRole()` - 支持指定角色注册
- `registerTeacher()` - 专门的教师注册方法
- `assignRole()` - 角色分配逻辑
- 修改`register()` - 现在会自动分配USER角色

### 4. Controller层修改

#### 4.1 AuthController.java
添加教师注册接口：
```java
// 教师注册请求参数
@Data
public static class TeacherRegisterRequest {
    @NotBlank(message = "用户名不能为空")
    private String username;
    @NotBlank(message = "密码不能为空")
    private String password;
    @NotBlank(message = "真实姓名不能为空")
    private String realName;
    private String phone;
    private String email;
    private Long schoolId;
    private String department;  // 部门/院系
    private String title;       // 职称
}

// 教师注册接口
@PostMapping("/register/teacher")
@Operation(summary = "教师注册", description = "注册教师用户（自动分配TEACHER角色）")
public ApiResult<Boolean> registerTeacher(@Valid @RequestBody TeacherRegisterRequest request)
```

#### 4.2 BackendController.java
添加教师管理接口：

1. **GET /backend/teacher/list** - 教师列表查询
   - 参数：schoolId(可选), keyword(可选), current, size
   - 权限：ADMIN

2. **POST /backend/teacher/add** - 新增教师
   - 参数：name, teacherNumber, schoolId, department, title, subject, phone, email, hireDate
   - 权限：ADMIN

3. **POST /backend/teacher/update** - 更新教师
   - 参数：id, name, teacherNumber, schoolId, department, title, subject, phone, email, hireDate, status
   - 权限：ADMIN

4. **DELETE /backend/teacher/delete** - 删除教师
   - 参数：id
   - 权限：ADMIN

## API接口说明

### 认证相关

#### 1. 教师注册
```
POST /auth/register/teacher
Content-Type: application/json

{
  "username": "teacher01",
  "password": "123",
  "realName": "王老师",
  "phone": "13800138010",
  "email": "wang@edu.com",
  "schoolId": 1,
  "department": "数学教研组",
  "title": "高级教师"
}
```

#### 2. 教师登录
```
POST /auth/login
Content-Type: application/json

{
  "username": "teacher01",
  "password": "123"
}
```

返回：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userInfo": {
      "id": 2,
      "username": "teacher01",
      "realName": "王老师",
      "department": "数学教研组",
      "title": "高级教师",
      "roles": ["TEACHER"],
      "permissions": []
    }
  }
}
```

#### 3. 获取用户信息
```
GET /auth/info
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

### 教师管理相关（需要ADMIN权限）

#### 1. 教师列表
```
GET /backend/teacher/list?schoolId=1&keyword=王¤t=1&size=10
```

#### 2. 新增教师
```
POST /backend/teacher/add
Content-Type: application/json

{
  "name": "李老师",
  "teacherNumber": "T002",
  "schoolId": 1,
  "department": "语文教研组",
  "title": "一级教师",
  "subject": "语文",
  "phone": "13800138011",
  "email": "li@edu.com",
  "hireDate": "2021-09-01"
}
```

#### 3. 更新教师
```
POST /backend/teacher/update
Content-Type: application/json

{
  "id": 1,
  "name": "王老师(修改)",
  "teacherNumber": "T001",
  "schoolId": 1,
  "department": "数学教研组",
  "title": "高级教师",
  "subject": "数学",
  "phone": "13800138010",
  "email": "wang@edu.com",
  "hireDate": "2020-09-01",
  "status": 1
}
```

#### 4. 删除教师
```
DELETE /backend/teacher/delete?id=1
```

## 权限控制

### 在Controller中使用
```java
// 只有教师可以访问
@PreAuthorize("hasRole('TEACHER')")
public ApiResult<Boolean> someTeacherMethod() { ... }

// 只有管理员可以访问
@PreAuthorize("hasRole('ADMIN')")
public ApiResult<Boolean> someAdminMethod() { ... }

// 已登录用户都可以访问
@PreAuthorize("isAuthenticated()")
public ApiResult<Boolean> someAuthMethod() { ... }
```

### 在前端使用
登录后，用户信息中包含roles数组：
```javascript
// 前端可以根据角色显示不同菜单
if (userInfo.roles.includes('TEACHER')) {
  // 显示教师功能菜单
}
if (userInfo.roles.includes('ADMIN')) {
  // 显示管理功能菜单
}
```

## 数据库表结构

### 相关表
1. **user** - 用户表（包含department, title字段）
2. **teacher** - 教师表（关联user_id）
3. **role** - 角色表（添加TEACHER角色）
4. **user_role** - 用户角色关联表

### 教师数据流程
```
用户注册 → user表插入记录 → teacher表插入记录 → user_role表分配TEACHER角色
```

## 测试步骤

### 1. 执行SQL脚本
```bash
# 在MySQL中执行
mysql> source backend/database/ADD_TEACHER_ROLE_COMPLETE.sql
```

### 2. 编译项目
```bash
cd /e/shixun/backend
mvn clean compile
```

### 3. 启动应用
```bash
mvn spring-boot:run
```

### 4. 测试API
使用Postman或curl测试以下接口：

**教师注册：**
```bash
curl -X POST http://localhost:8080/auth/register/teacher \
  -H "Content-Type: application/json" \
  -d '{"username":"teacher01","password":"123","realName":"王老师","phone":"13800138010","email":"wang@edu.com","schoolId":1,"department":"数学教研组","title":"高级教师"}'
```

**教师登录：**
```bash
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"teacher01","password":"123"}'
```

**查询教师列表（需要ADMIN角色）：**
```bash
curl -X GET "http://localhost:8080/backend/teacher/list?current=1&size=10" \
  -H "Authorization: Bearer <token>"
```

## 注意事项

1. **数据库初始化**：必须先执行SQL脚本添加TEACHER角色
2. **密码加密**：系统使用BCrypt加密，测试密码123对应的密文已预置
3. **权限控制**：教师管理接口需要ADMIN角色，教师登录后有TEACHER角色
4. **教师表关联**：教师信息通过user_id与用户表关联
5. **逻辑删除**：所有表都支持逻辑删除（deleted字段）

## 文件清单

### SQL脚本
- `backend/database/ADD_TEACHER_ROLE_COMPLETE.sql` - 完整添加教师角色脚本
- `backend/database/add_teacher_role.sql` - 仅添加角色脚本
- `backend/database/test_teacher_role.sql` - 测试脚本

### Java代码
- `mapper/UserMapper.java` - 添加角色分配方法
- `mapper/UserMapper.xml` - 添加SQL映射
- `service/IUserService.java` - 添加教师相关接口
- `service/impl/UserServiceImpl.java` - 实现教师相关方法
- `controller/AuthController.java` - 添加教师注册接口
- `controller/BackendController.java` - 添加教师管理接口

### 文档
- `教师角色添加说明.md` - 本说明文档

## 后续扩展建议

1. **教师特定权限**：可以为TEACHER角色添加特定权限（如成绩录入、学生管理等）
2. **教师个人中心**：添加教师个人信息修改接口
3. **班级管理**：添加教师所教班级管理功能
4. **课程表管理**：教师可以管理自己的课程表
5. **学生管理**：教师可以管理所教班级的学生

## 总结

通过以上修改，系统现在支持三种角色：
- **ADMIN** - 系统管理员，可以管理所有内容
- **TEACHER** - 教师，可以管理班级、录入成绩等
- **USER** - 普通用户，基础权限

教师可以通过专门的注册接口注册，也可以由管理员在后台添加。系统通过Spring Security的`@PreAuthorize`注解进行权限控制，确保不同角色只能访问对应的资源。
