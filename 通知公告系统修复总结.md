# 通知公告系统修复总结

## 问题描述

学生用户在"通知公告"页面看到"No Data"，即使管理员已经发布了文档公告。

## 根本原因分析

### 1. CampusPortalController 查询逻辑错误

**问题代码（原始）：**
```java
wrapper.and(q -> q
    .or(q1 -> q1.isNull(Announcement::getSchoolId))
    .or(q2 -> q2
        .eq(Announcement::getSchoolId, user.getSchoolId())
        .or()
        .eq(Announcement::getClassId, user.getClassId())
        .or()
        .isNull(Announcement::getClassId)
    )
);
```

**问题：** 这个逻辑会返回：
- 所有schoolId=null的公告（管理员公告）
- 所有schoolId=用户学校ID的公告（不管classId）
- 所有classId=用户班级ID的公告（不管schoolId）

这会导致返回大量不相关的公告，或者因为逻辑混乱而返回空结果。

### 2. 教师发布通知/作业时公告创建不完整

**问题：**
- `publishAnnouncement()` - 只有当recipients是List时才设置classId
- `publishAssignment()` - 只有当targetClassesObj是List时才设置classId

这导致公告的classId可能为null，使通知变成全校可见，而不是仅本班级可见。

### 3. 管理员用户schoolId为null

管理员用户的schoolId是null，所以发布的公告schoolId也是null。这在逻辑上是正确的（管理员公告全校可见），但需要查询逻辑支持。

## 修复方案

### 1. 修复 CampusPortalController.getAnnouncements()

**修复后的代码：**
```java
// 查询学校级别和班级级别的公告
// 学生可以查看：
// 1) schoolId为null的公告（管理员发布的全校通知）
// 2) 本学校的所有学校级别公告(classId为null)
// 3) 本班级的公告
wrapper.and(q -> q
    .or(q1 -> q1.isNull(Announcement::getSchoolId))  // 管理员发布的全校通知
    .or(q2 -> q2
        .eq(Announcement::getSchoolId, schoolId)
        .and(q3 -> q3
            .isNull(Announcement::getClassId)
            .or()
            .eq(Announcement::getClassId, classId)
        )
    )
);
```

**逻辑说明：**
- `schoolId IS NULL` → 管理员公告，所有学生可见
- `schoolId = ? AND classId IS NULL` → 学校公告，本校学生可见
- `schoolId = ? AND classId = ?` → 班级公告，本班学生可见

### 2. 修复 TeacherController.publishAnnouncement()

**修复前：**
```java
Object recipientsObj = announcementData.get("recipients");
if (recipientsObj instanceof List) {
    // ... 设置classId
}
```

**修复后：**
```java
// 教师发布的通知默认只对本班级可见
if (!teacherClasses.isEmpty()) {
    announcement.setClassId(teacherClasses.get(0).getId());
}
```

### 3. 修复 TeacherController.publishAssignment()

**修复前：**
```java
if (targetClassesObj instanceof List && !((List<?>) targetClassesObj).isEmpty()) {
    if (!teacherClasses.isEmpty()) {
        announcement.setClassId(teacherClasses.get(0).getId());
    }
}
```

**修复后：**
```java
// 作业通知默认只对本班级可见
if (!teacherClasses.isEmpty()) {
    announcement.setClassId(teacherClasses.get(0).getId());
}
```

## 通知可见性规则

| 发布者 | 学校ID | 班级ID | 可见范围 |
|--------|--------|--------|----------|
| 管理员 | null | null | 所有学生 |
| 教师 | 学校ID | 班级ID | 本班级学生 |
| 教师 | 学校ID | null | 本学校学生（理论上） |

## 测试验证

### 测试场景1：管理员发布文档
1. 管理员登录 → 发布文档（分类=通知公告）
2. 学生登录 → 查看通知公告
3. **预期结果：** 学生能看到管理员发布的公告

### 测试场景2：教师发布作业
1. 教师登录 → 发布作业
2. 对应班级的学生登录 → 查看通知公告
3. **预期结果：** 学生能看到作业通知
4. 其他班级的学生登录 → 查看通知公告
5. **预期结果：** 其他学生看不到该作业通知

### 测试场景3：教师发布通知
1. 教师登录 → 发布通知
2. 对应班级的学生登录 → 查看通知公告
3. **预期结果：** 学生能看到教师通知
4. 其他班级的学生登录 → 查看通知公告
5. **预期结果：** 其他学生看不到该教师通知

## 修改文件清单

1. `E:\shixun\backend\src\main\java\com\education\platform\controller\CampusPortalController.java`
   - 修改 `getAnnouncements()` 方法的查询逻辑

2. `E:\shixun\backend\src\main\java\com\education\platform\controller\TeacherController.java`
   - 修改 `publishAnnouncement()` 方法，确保总是设置classId
   - 修改 `publishAssignment()` 方法，确保总是设置classId

## 注意事项

1. **数据库中的历史数据：** 已经存在的公告可能classId为null，这些公告会被视为学校级别公告（本校可见）

2. **教师班级：** 教师必须有负责的班级，否则无法发布通知

3. **管理员学校：** 管理员的schoolId为null是正常的，表示管理员级别

4. **前端兼容性：** 前端代码不需要修改，只需要后端正确返回数据
