# 通知公告系统快速修复脚本

## 一键修复步骤

### 1. 停止后端服务
```bash
# 如果使用IDE，停止Spring Boot应用
# 或者使用命令行停止进程
```

### 2. 检查修改的文件

#### 文件1：CampusPortalController.java
```java
// E:\shixun\backend\src\main\java\com\education\platform\controller\CampusPortalController.java
// 第714-724行

wrapper.and(q -> q
    .or(q1 -> q1.isNull(Announcement::getSchoolId))  // 管理员发布的全校通知
    .or(q2 -> q2
        .eq(Announcement::getSchoolId, schoolId)
        .and(q3 -> q3
            .isNull(Announcement::getClassId)
            .or()
            .eq(Announcement::getClassId, classId)
        )
    )
);
```

#### 文件2：TeacherController.java - publishAnnouncement()
```java
// E:\shixun\backend\src\main\java\com\education\platform\controller\TeacherController.java
// 第1057-1064行

// 设置班级ID（教师通知只对本班级可见）
// 教师发布的通知默认只对本班级可见
if (!teacherClasses.isEmpty()) {
    announcement.setClassId(teacherClasses.get(0).getId());
} else {
    // 如果没有班级，设置为null（但这种情况应该已经被前面的检查拦截）
    announcement.setClassId(null);
}
```

#### 文件3：TeacherController.java - publishAssignment()
```java
// E:\shixun\backend\src\main\java\com\education\platform\controller\TeacherController.java
// 第204-207行

// 作业通知默认只对本班级可见
if (!teacherClasses.isEmpty()) {
    announcement.setClassId(teacherClasses.get(0).getId());
}
```

### 3. 重新编译后端
```bash
cd E:\shixun\backend
mvn clean package -DskipTests
```

### 4. 重启后端服务
```bash
java -jar target/education-platform-0.0.1-SNAPSHOT.jar
```

### 5. 测试验证

#### 测试1：管理员发布
1. 登录：admin / admin123
2. 发布文档，分类=通知公告
3. 查看是否创建成功

#### 测试2：学生查看
1. 登录学生账号
2. 进入通知公告页面
3. 应该能看到管理员公告

#### 测试3：教师发布作业
1. 登录教师账号
2. 发布作业
3. 对应班级学生应该能看到通知

#### 测试4：教师发布通知
1. 登录教师账号
2. 发布通知
3. 对应班级学生应该能看到通知

## 常见问题

### Q1: 修改后没有生效？
A: 检查是否重新编译并重启了服务

### Q2: 学生还是看不到公告？
A: 检查：
1. 学生的school_id和class_id是否正确
2. 公告的school_id和class_id是否正确
3. 运行验证脚本查看数据

### Q3: 教师发布通知失败？
A: 检查教师是否有负责的班级

## 数据库检查命令

```sql
-- 查看所有公告
SELECT id, title, school_id, class_id, status FROM announcement;

-- 查看管理员用户
SELECT id, username, school_id, class_id FROM user WHERE username = 'admin';

-- 查看学生用户
SELECT id, username, school_id, class_id FROM user WHERE username = 'xuesheng';

-- 查看教师用户
SELECT id, username, school_id, class_id FROM user WHERE username = '123';
```

## 回滚方案

如果修复后出现问题，可以回滚到原始代码：

### CampusPortalController.java 原始代码
```java
wrapper.and(q -> q
    .or(q1 -> q1.isNull(Announcement::getSchoolId))
    .or(q2 -> q2
        .eq(Announcement::getSchoolId, schoolId)
        .or()
        .eq(Announcement::getClassId, classId)
        .or()
        .isNull(Announcement::getClassId)
    )
);
```

### TeacherController.java publishAnnouncement() 原始代码
```java
Object recipientsObj = announcementData.get("recipients");
if (recipientsObj instanceof List) {
    List<?> recipients = (List<?>) recipientsObj;
    if (!teacherClasses.isEmpty()) {
        announcement.setClassId(teacherClasses.get(0).getId());
    }
}
```

### TeacherController.java publishAssignment() 原始代码
```java
if (targetClassesObj instanceof List && !((List<?>) targetClassesObj).isEmpty()) {
    if (!teacherClasses.isEmpty()) {
        announcement.setClassId(teacherClasses.get(0).getId());
    }
}
```

## 联系方式

如果遇到问题，请检查：
1. 后端日志输出
2. 数据库数据状态
3. 前端浏览器控制台错误
4. 网络请求响应
