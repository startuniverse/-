# 课程表功能修复说明

## 问题描述
**用户反馈：**
> 教师端点击进入我的课表界面，点击添加课程，添加完毕后，进入学生用户xuesheng，点击课程表，没有发现教师端所添加的课程。

## 根本原因分析

### 1. 后端问题
**TeacherController.java** 中的课程添加逻辑存在缺陷：

```java
// 修复前的问题代码
@PostMapping("/timetable")
public ApiResult<Boolean> addTimetable(@RequestBody Timetable timetable) {
    // 缺少：自动获取教师负责的班级
    // 缺少：验证 classId 是否为空
    // 直接保存，可能导致 classId 为 null 或错误值
    timetableMapper.insert(timetable);
}
```

**问题点：**
- 教师添加课程时，前端传递的 `classId` 可能为空或错误
- 后端没有自动获取教师负责的班级
- 课程可能被保存到错误的班级或 class_id = NULL

### 2. 前端问题
**Timetable.vue** 中的表单设计不合理：

```javascript
// 修复前的问题代码
const addForm = ref({
  // ...
  classId: 1,  // 硬编码为1，可能导致添加到错误班级
  // ...
})
```

**问题点：**
- 使用硬编码的 `classId: 1`
- 没有提供班级选择界面
- 教师无法选择要添加到哪个班级

## 修复方案

### 后端修复

#### 1. 新增获取教师班级接口
```java
@GetMapping("/classes")
public ApiResult<List<Map<String, Object>>> getTeacherClasses(
        @RequestHeader(value = "Authorization", required = false) String token) {
    // 从token获取教师ID
    // 查询 teacher 表获取教师记录
    // 查询 class 表 WHERE head_teacher_id = 教师ID
    // 返回 [{id: 2, className: "高一(2)班"}]
}
```

#### 2. 修复添加课程接口
```java
@PostMapping("/timetable")
public ApiResult<Boolean> addTimetable(
        @RequestHeader(value = "Authorization", required = false) String token,
        @RequestBody Timetable timetable) {

    // 1. 获取教师信息
    Long teacherUserId = getUserIdFromToken(token);
    Teacher teacher = teacherMapper.selectOne(...);

    // 2. 自动设置班级（关键修复）
    if (timetable.getClassId() == null) {
        List<Class> teacherClasses = classMapper.selectList(
            new LambdaQueryWrapper<Class>()
                .eq(Class::getHeadTeacherId, teacher.getId())
        );
        if (teacherClasses.isEmpty()) {
            return ApiResult.error("您还没有负责的班级");
        }
        timetable.setClassId(teacherClasses.get(0).getId());
    }

    // 3. 设置其他必要字段
    timetable.setTeacherId(teacher.getId());
    timetable.setSchoolId(teacherUser.getSchoolId());
    timetable.setDeleted(0);

    // 4. 保存
    timetableMapper.insert(timetable);
    return ApiResult.success(true);
}
```

#### 3. 修复批量添加接口
```java
@PostMapping("/timetable/batch")
public ApiResult<Map<String, Object>> batchAddTimetable(...) {
    // 类似逻辑，为每条记录自动设置 classId
    for (Timetable timetable : timetables) {
        if (timetable.getClassId() == null) {
            timetable.setClassId(defaultClassId);
        }
        // ...
    }
}
```

### 前端修复

#### 1. 添加获取班级列表功能
```javascript
import { getTeacherClasses } from '@/api/teacher'

const teacherClasses = ref([])

const loadTeacherClasses = async () => {
  try {
    const data = await getTeacherClasses()
    teacherClasses.value = data
    // 默认选择第一个班级
    if (data.length > 0) {
      addForm.value.classId = data[0].id
    }
  } catch (error) {
    ElMessage.error('加载班级列表失败')
  }
}
```

#### 2. 更新表单UI
```vue
<!-- 修复前 -->
<el-form-item label="班级">
  <el-input v-model="addForm.classId" placeholder="班级ID" />
</el-form-item>

<!-- 修复后 -->
<el-form-item label="班级">
  <el-select v-model="addForm.classId" placeholder="选择班级">
    <el-option
      v-for="cls in teacherClasses"
      :key="cls.id"
      :label="cls.className"
      :value="cls.id"
    />
  </el-select>
</el-form-item>
```

#### 3. 更新表格显示
```vue
<!-- 修复前 -->
<el-table-column prop="classId" label="班级ID" />

<!-- 修复后 -->
<el-table-column prop="className" label="班级">
  <template #default="scope">
    {{ scope.row.className }}
  </template>
</el-table-column>
```

## 数据流程

### 教师添加课程
```
1. 教师登录 → 获取token
2. 进入"我的课表"页面
3. 页面加载时调用 GET /teacher/classes
   ↓
4. 后端：从token获取教师ID
5. 后端：查询教师负责的班级
6. 前端：显示班级下拉框
7. 教师选择班级、填写课程信息
8. 点击"添加" → POST /teacher/timetable
   ↓
9. 后端：验证token，获取教师信息
10. 后端：如果classId为空，自动设置为教师负责的第一个班级
11. 后端：保存到数据库（包含正确的class_id）
12. 返回成功
```

### 学生查看课程表
```
1. 学生登录 → 获取token
2. 进入"课程表"页面
3. 页面调用 GET /campus/timetable
   ↓
4. 后端：从token获取学生ID
5. 后端：查询学生记录，获取 class_id
6. 后端：查询 timetable WHERE class_id = ?
7. 后端：JOIN teacher 和 user 表获取教师姓名
8. 返回课程列表
9. 前端：显示课程表
```

## 数据库验证

### 检查课程表数据
```sql
-- 查看高一(2)班的所有课程
SELECT
    t.id,
    t.subject,
    t.week_day,
    t.period,
    t.start_time,
    t.end_time,
    t.classroom,
    c.class_name,
    u.real_name as teacher_name
FROM timetable t
JOIN class c ON t.class_id = c.id
JOIN teacher tea ON t.teacher_id = tea.id
JOIN user u ON tea.user_id = u.id
WHERE t.class_id = 2
  AND t.deleted = 0
ORDER BY t.week_day, t.period;
```

### 检查教师班级关系
```sql
-- 查看教师负责的班级
SELECT
    t.id as teacher_id,
    u.real_name as teacher_name,
    c.id as class_id,
    c.class_name
FROM teacher t
JOIN user u ON t.user_id = u.id
LEFT JOIN class c ON c.head_teacher_id = t.id
WHERE t.deleted = 0;
```

## 测试步骤

### 1. 教师端测试
```
账号: teacher1 / admin
步骤:
1. 登录系统
2. 进入"我的课表"页面
3. 点击"添加课程"
4. 观察班级选择框（应该显示"高一(2)班"）
5. 填写课程信息：
   - 星期: 星期一
   - 节次: 5
   - 科目: 物理
   - 班级: 高一(2)班
   - 教室: A105
   - 开始时间: 14:00
   - 结束时间: 14:45
   - 教学周: 全周
6. 点击"确定"
7. 验证：课程表列表中显示新添加的课程
```

### 2. 学生端测试
```
账号: student1 / admin
步骤:
1. 登录系统
2. 进入"课程表"页面
3. 验证：能看到教师添加的物理课程
4. 验证：显示正确的教师姓名、教室、时间
```

## 修复文件清单

### 后端文件
- ✅ `backend/src/main/java/com/education/platform/controller/TeacherController.java`
  - 添加 ClassMapper 依赖注入
  - 新增 GET /teacher/classes 接口
  - 修复 POST /timetable 接口（自动设置 classId）
  - 修复 POST /timetable/batch 接口（自动设置 classId）
  - 添加 ArrayList 导入

### 前端文件
- ✅ `frontend/src/views/teacher/Timetable.vue`
  - 添加 teacherClasses 状态
  - 添加 loadTeacherClasses() 函数
  - 更新表单使用下拉框选择班级
  - 更新表格显示班级名称
  - onMounted 时加载班级列表

- ✅ `frontend/src/api/teacher.js`
  - 添加 getTeacherClasses() API 函数

## 修复效果

### 修复前
- ❌ 教师添加课程时无法选择班级
- ❌ 课程可能保存到错误班级或 class_id = NULL
- ❌ 学生看不到教师添加的课程
- ❌ 表格显示数字 ID 而非班级名称

### 修复后
- ✅ 教师通过下拉框选择班级
- ✅ 课程自动关联到教师负责的班级
- ✅ 学生可以正常看到课程表
- ✅ 表格显示友好的班级名称
- ✅ 支持批量添加课程

## 注意事项

1. **教师必须有负责的班级**
   - 如果教师没有负责的班级，添加课程时会报错
   - 需要先在数据库中为教师分配班级

2. **班级选择优先级**
   - 优先使用前端选择的班级
   - 如果未选择，自动使用教师负责的第一个班级

3. **批量添加**
   - 批量添加时，未选择班级的行会自动使用默认班级
   - 可以混合选择不同班级

4. **数据一致性**
   - 所有课程必须有正确的 class_id
   - 删除教师或班级时，需要考虑级联关系

## 相关API接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/teacher/classes` | GET | 获取教师负责的班级列表 |
| `/teacher/timetable` | POST | 添加课程（自动设置班级） |
| `/teacher/timetable/batch` | POST | 批量添加课程 |
| `/teacher/timetable/{id}` | DELETE | 删除课程 |
| `/teacher/timetable` | GET | 获取教师课程表 |
| `/campus/timetable` | GET | 获取学生课程表 |

## 总结

本次修复解决了教师添加课程无法在学生端显示的问题，核心改进：

1. **后端自动化**：自动获取和设置班级ID，减少人为错误
2. **前端友好化**：提供班级选择界面，显示班级名称
3. **数据完整性**：确保每条课程记录都有正确的班级关联
4. **用户体验**：教师无需手动输入班级ID，学生看到完整课程信息

修复后，教师可以正常添加课程，学生可以正常查看课程表，功能恢复正常。