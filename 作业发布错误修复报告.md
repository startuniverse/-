# 作业发布错误修复报告

## 问题描述

**错误时间：** 2026-01-10 11:51:00

**错误现象：** 教师用户（123）在发布作业时失败，报错信息：
```
作业发布失败: ### Error updating database. Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 'created_at' in 'field list'
```

**SQL错误：**
```sql
INSERT INTO assignment ( title, subject, content, target_classes, deadline, difficulty, is_graded, notes, teacher_id, school_id, status, publish_time, created_at, updated_at )
VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )
```

## 问题根源

### 数据库表结构不一致

| 表名 | 创建时间字段 | 更新时间字段 | 状态 |
|------|-------------|-------------|------|
| user | `created_at` | `updated_at` | ✅ 正常 |
| announcement | `created_at` | `updated_at` | ✅ 正常 |
| class | `created_at` | `updated_at` | ✅ 正常 |
| school | `created_at` | `updated_at` | ✅ 正常 |
| **assignment** | **`create_time`** | **`update_time`** | ❌ **不一致** |

### 代码层面

**BaseEntity.java** 定义：
```java
@TableField(fill = FieldFill.INSERT)
private LocalDateTime createdAt;  // MyBatis-Plus 自动映射为 created_at

@TableField(fill = FieldFill.INSERT_UPDATE)
private LocalDateTime updatedAt;  // MyBatis-Plus 自动映射为 updated_at
```

**Assignment.java** 继承 BaseEntity：
```java
@TableName("assignment")
public class Assignment extends BaseEntity {
    // 继承了 createdAt 和 updatedAt 字段
}
```

**MyBatis-Plus 行为：**
- 实体字段 `createdAt` → 数据库列 `created_at`
- 实体字段 `updatedAt` → 数据库列 `updated_at`

**问题：** 数据库 `assignment` 表只有 `create_time` 和 `update_time`，没有 `created_at` 和 `updated_at`

## 修复方案

### 方案选择：修改数据库表结构（推荐）

**理由：**
1. 保持所有表结构一致性
2. 符合项目的整体设计规范
3. 避免在每个实体类中重复添加字段映射注解

### 修复步骤

#### 1. 修改 schema.sql（已执行）
```sql
-- 修改前
`create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
`update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

-- 修改后
`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
```

#### 2. 更新现有数据库（需要执行）
```sql
ALTER TABLE assignment
CHANGE COLUMN create_time created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间';

ALTER TABLE assignment
CHANGE COLUMN update_time updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间';
```

## 验证步骤

### 1. 执行数据库修复
```bash
# 连接MySQL并执行修复脚本
mysql -u root -p education_platform < E:\shixun\fix_assignment_table.sql
```

### 2. 验证表结构
```sql
DESC assignment;
```
应该看到：
```
Field       | Type         | Null | Key | Default           | Extra
created_at  | datetime     | YES  |     | CURRENT_TIMESTAMP |
updated_at  | datetime     | YES  |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP
```

### 3. 重新编译后端
```bash
cd E:\shixun\backend
mvn clean package -DskipTests
```

### 4. 重启服务并测试

#### 测试场景：
1. **登录教师账号**：123 / 123
2. **进入作业管理**：发布新作业
3. **填写信息**：
   - 标题：测试作业修复
   - 科目：chinese
   - 内容：测试作业发布功能是否正常
   - 班级：选择班级
   - 截止时间：2026-01-24
   - 难度：medium
   - 是否计分：是
4. **提交**：应该成功

#### 预期结果：
- ✅ 作业发布成功
- ✅ 数据库中能查到新记录
- ✅ created_at 和 updated_at 字段有值
- ✅ 学生用户能看到该作业通知

## 相关文件修改

### 1. 数据库定义
- **文件：** `E:\shixun\database\schema.sql`
- **修改：** 第466-467行
- **内容：** `create_time` → `created_at`, `update_time` → `updated_at`

### 2. 修复脚本
- **文件：** `E:\shixun\fix_assignment_table.sql`
- **内容：** 数据库字段修改命令

### 3. 已知影响范围

#### 可能受影响的功能：
- ✅ 作业发布（主要修复目标）
- ✅ 作业更新（updated_at 自动更新）
- ✅ 作业查询（created_at 用于排序）
- ✅ 作业删除（逻辑删除依赖 deleted 字段）

#### 不受影响的功能：
- ✅ 公告发布（使用 announcement 表，字段正确）
- ✅ 用户管理（使用 user 表，字段正确）
- ✅ 班级管理（使用 class 表，字段正确）

## 回滚方案

如果修改后出现问题，可以回滚：

```sql
-- 回滚 schema.sql
ALTER TABLE assignment
CHANGE COLUMN created_at create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间';

ALTER TABLE assignment
CHANGE COLUMN updated_at update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间';
```

## 修复完成确认

- [x] 分析问题根源
- [x] 确定修复方案
- [x] 修改 schema.sql
- [x] 创建修复脚本
- [x] 编写验证步骤
- [ ] 执行数据库修复（待执行）
- [ ] 重新编译后端（待执行）
- [ ] 测试作业发布功能（待执行）

## 下一步操作

1. **立即执行：** 在数据库中执行修复脚本
2. **重新编译：** 后端代码（虽然Java代码未修改，但建议重新编译）
3. **测试验证：** 教师发布作业功能
4. **监控日志：** 确认没有其他类似问题

## 注意事项

1. **数据库备份：** 执行前建议备份数据库
2. **服务状态：** 确保没有正在进行的作业发布操作
3. **权限检查：** 确保数据库用户有 ALTER TABLE 权限
4. **数据安全：** 字段改名不会丢失数据，但建议先测试

## 预期修复效果

修复后，以下流程应该正常工作：

```
教师发布作业
    ↓
AssignmentService.save(assignment)
    ↓
MyBatis-Plus 插入数据
    ↓
INSERT INTO assignment (..., created_at, updated_at, ...)
    ↓
数据库成功插入（字段名匹配）
    ↓
返回成功响应
    ↓
前端显示"作业发布成功"
```

---

**修复状态：** ✅ 方案已确定，待执行
**修复日期：** 2026-01-10
**修复人员：** Claude Code
**紧急程度：** 高（影响教师核心功能）
